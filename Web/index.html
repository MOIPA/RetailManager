<!doctype html>
<html class="x-admin-sm">

<head>
    <meta charset="UTF-8">
    <title>retail manager</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
        content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="./css/font.css">
    <link rel="stylesheet" href="./css/xadmin.css">
    <!-- <link rel="stylesheet" href="./css/theme5.css"> -->
    <script src="./lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="./js/xadmin.js"></script>
    <script>
            // 是否开启刷新记忆tab功能
            // var is_remember = false;
    </script>
</head>

<body class="index">
    <!-- 顶部开始 -->
    <div class="container">
        <div class="logo">
            <a href="./index.html">reatail managemen</a>
        </div>
        <div class="left_open">
            <a><i title="open right" class="iconfont">&#xe699;</i></a>
        </div>
        <ul class="layui-nav right" lay-filter="">
            <li class="layui-nav-item">
                <a href="javascript:;" id="user"></a>
                <dl class="layui-nav-child">
                    <!-- 二级菜单 -->
                    <dd>
                        <a onclick="xadmin.open('account config','./account/account-config.html')">account config</a>
                    </dd>
                    <dd>
                        <a href="./login.html">quit system</a>
                    </dd>
                </dl>
            </li>
            <li class="layui-nav-item to-index">
                <a href="/">welcome</a>
            </li>
        </ul>
    </div>
    <!-- 顶部结束 -->
    <!-- 中部开始 -->
    <!-- 左侧菜单开始 -->
    <div class="left-nav">
        <div id="side-nav">
            <ul id="nav">
                <li>
                    <a href="javascript:;">
                        <i class="iconfont left-nav-li" lay-tips="retail management">&#xe723;</i>
                        <cite>retail management</cite>
                        <i class="iconfont nav_right">&#xe697;</i></a>
                    <ul class="sub-menu">
                        <li>
                            <a onclick="xadmin.add_tab('retail show','retail/retail-show.html')">
                                <i class="iconfont">&#xe6a7;</i>
                                <cite>retail show</cite></a>
                        </li>
                        <li>
                            <a onclick="xadmin.add_tab('retail out','/retail/retail-out.html')">
                                <i class="iconfont">&#xe6a7;</i>
                                <cite>retail out</cite></a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="javascript:;">
                        <i class="iconfont left-nav-li" lay-tips="member management">&#xe726;</i>
                        <cite>staff management</cite>
                        <i class="iconfont nav_right">&#xe6a7;</i></a>
                    <ul class="sub-menu">
                        <li>
                            <a onclick="xadmin.add_tab('member list','member/member-list.html')">
                                <i class="iconfont">&#xe6a7;</i>
                                <cite>member list</cite></a>
                        </li>
                        <li>
                            <a onclick="xadmin.add_tab('member password','member/member-password.html')">
                                <i class="iconfont">&#xe6a7;</i>
                                <cite>member password</cite></a>
                        </li>
                        <li>
                            <a onclick="xadmin.add_tab('user management','member/user-management.html')">
                                <i class="iconfont">&#xe6a7;</i>
                                <cite>user management</cite></a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="javascript:;">
                        <i class="iconfont left-nav-li" lay-tips="purchase management">&#xe723;</i>
                        <cite>purchase management</cite>
                        <i class="iconfont nav_right">&#xe697;</i></a>
                    <ul class="sub-menu">
                        <li>
                            <a onclick="xadmin.add_tab('purchase in','purchase/purchase-in.html')">
                                <i class="iconfont">&#xe6a7;</i>
                                <cite>purchase in</cite></a>
                        </li>
                        <li>
                            <a onclick="xadmin.add_tab('purchase returns','purchase/purchase-out.html')">
                                <i class="iconfont">&#xe6a7;</i>
                                <cite>purchase out</cite></a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="javascript:;">
                        <i class="iconfont left-nav-li" lay-tips="item management">&#xe723;</i>
                        <cite>item management</cite>
                        <i class="iconfont nav_right">&#xe697;</i></a>
                    <ul class="sub-menu">
                        <li>
                            <a onclick="xadmin.add_tab('item list','item/item-list.html')">
                                <i class="iconfont">&#xe6a7;</i>
                                <cite>item list</cite></a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="javascript:;">
                        <i class="iconfont left-nav-li" lay-tips="storage management">&#xe6ce;</i>
                        <cite>storage management</cite>
                        <i class="iconfont nav_right">&#xe697;</i></a>
                    <ul class="sub-menu">
                        <li>
                            <a onclick="xadmin.add_tab('storage list','storage/storage-list.html')">
                                <i class="iconfont">&#xe6a7;</i>
                                <cite>storage list</cite></a>
                        </li>
                        <li>
                            <a onclick="xadmin.add_tab('storage item','storage/storage-item-detail.html')">
                                <i class="iconfont">&#xe6a7;</i>
                                <cite>storage item</cite></a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
    <!-- <div class="x-slide_left"></div> -->
    <!-- 左侧菜单结束 -->
    <!-- 右侧主体开始 -->
    <div class="page-content">
        <div class="layui-tab tab" lay-filter="xbs_tab" lay-allowclose="false">
            <ul class="layui-tab-title">
                <li class="home">
                    <i class="layui-icon">&#xe68e;</i>mydesk
                </li>
            </ul>
            <div class="layui-unselect layui-form-select layui-form-selected" id="tab_right">
                <dl>
                    <dd data-type="this">close current</dd>
                    <dd data-type="other">close other</dd>
                    <dd data-type="all">close all</dd>
                </dl>
            </div>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <iframe src='./welcome.html' frameborder="0" scrolling="yes" class="x-iframe"></iframe>
                </div>
            </div>
            <div id="tab_show"></div>
        </div>
    </div>
    <div class="page-content-bg"></div>
    <style id="theme_style"></style>
</body>
<div id="shortageItem">
    <blockquote class="layui-elem-quote layui-text">
        shortage detail
    </blockquote>
    <table class="layui-hide" id="shortage" lay-filter="shortage"></table>
</div>
<!-- 右侧主体结束 -->
<!-- 中部结束 -->
<script src="./lib/jquery-3.5.1.js"></script>
<script src="./lib/socket.io.js"></script>

<script type="module">
    //JavaScript代码区域
    // 判断是否登陆
    import urlInfo from './baseURL.js'
    layui.use(['element', 'layer', 'table'], function () {
        var element = layui.element;
        var table = layui.table;

        $.get(urlInfo.sessionCheck, {
            userId: localStorage.getItem("userId"),
            token: localStorage.getItem("token")
        }, function (data, status) {
            if (data == -1) {
                // 用户未登录过 跳转到登陆页面
                layer.msg('please login');
                setTimeout(() => {
                    window.location.href = "./login.html";
                    window.event.returnValue = false;
                }, 1500);
            } else {
                $('#user').text(localStorage.getItem("userName"));
                console.log("logined user" + localStorage.getItem("userName"));
            }
        });
        layer.open({
            type: 1
            , content: $('#shortageItem') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
            , offset: 'rb'
            , area: ['400px', '300px']
            , shade: 0
            , title: false
            , closeBtn: 0
        });

        var socket;
        connect();
        socket.emit('detectStorage', localStorage.getItem("userId"));

        var shortageT = table.render({
            elem: '#shortage'
            , height: '270px'
            , defaultToolbar: ['filter', 'exports', 'print', {
                title: 'tips'
                , layEvent: 'LAYTABLE_TIPS'
                , icon: 'layui-icon-tips'
            }]
            , cols: [[
                // , { field: 'itemId', title: 'itemId', sort: true }
                , { field: 'name', title: 'name' }
                // , { field: 'storageId', title: 'storageId', sort: true }
                , { field: 'safeNumber', title: 'safeNumber', sort: true }
                , { field: 'number', title: 'number' }
            ]]
            , page: false
            , data: []
        });

        function connect() {
            var opts = {
                query: 'loginUserNum=' + localStorage.getItem("userId")
            };
            socket = io.connect('http://localhost:9090', opts);
            socket.on('connect', function () {
                console.log("socket connected");
            });
            socket.on('storageStatus', function (data) {
                data = data.itemLists;
                var myData = [];
                for (let i = 0; i < data.length; i++) {
                    const d = data[i];
                    myData.push({
                        "itemId": d.itemId,
                        "name": d.name,
                        "storageId": d.storageId,
                        "safeNumber": d.safeNumber,
                        "number": d.number,
                    });
                }
                shortageT.reload({ data: myData });
            });

            socket.on('disconnect', function () {
                console.log("socket disconnect");
            });
        }

    });

</script>

</html>